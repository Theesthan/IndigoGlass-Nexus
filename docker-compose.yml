# =============================================================================
# IndigoGlass Nexus - Docker Compose (Development)
# =============================================================================
# Usage: docker compose up --build -d
# =============================================================================

version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # Frontend - Next.js Dashboard
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
    container_name: indigoglass-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
      - NEXT_PUBLIC_APP_NAME=IndigoGlass Nexus
    depends_on:
      - api
    networks:
      - indigoglass-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # API Service - FastAPI
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: indigoglass-api
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=INFO
      - SECRET_KEY=dev-secret-key-change-in-production-32chars
      - JWT_SECRET_KEY=dev-jwt-secret-key-change-in-prod-32c
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=indigoglass
      - MYSQL_USER=indigoglass
      - MYSQL_PASSWORD=indigoglass_password
      - MONGODB_URL=mongodb://indigoglass:indigoglass_mongo_password@mongodb:27017/indigoglass_raw?authSource=admin
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4j_password
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - OPTIMIZER_URL=http://optimizer:8080
      - CORS_ORIGINS=http://localhost:3000
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_started
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
    networks:
      - indigoglass-net
    volumes:
      - ./services/api:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # Ingestion Worker - Celery
  # ---------------------------------------------------------------------------
  ingestion-worker:
    build:
      context: ./jobs/ingestion
      dockerfile: Dockerfile
    container_name: indigoglass-ingestion
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=indigoglass
      - MYSQL_USER=indigoglass
      - MYSQL_PASSWORD=indigoglass_password
      - MONGODB_URL=mongodb://indigoglass:indigoglass_mongo_password@mongodb:27017/indigoglass_raw?authSource=admin
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=neo4j_password
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
    depends_on:
      - api
      - redis
    networks:
      - indigoglass-net
    volumes:
      - ./jobs/ingestion:/app
      - ./data/synthetic:/data/synthetic:ro

  # ---------------------------------------------------------------------------
  # ML Training Job
  # ---------------------------------------------------------------------------
  ml-train:
    build:
      context: ./jobs/ml
      dockerfile: Dockerfile
    container_name: indigoglass-ml-train
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=indigoglass
      - MYSQL_USER=indigoglass
      - MYSQL_PASSWORD=indigoglass_password
      - REDIS_URL=redis://redis:6379/0
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET_MODELS=models
      - ML_RANDOM_SEED=42
    depends_on:
      - mysql
      - minio
    networks:
      - indigoglass-net
    volumes:
      - ./jobs/ml:/app
    profiles:
      - ml

  # ---------------------------------------------------------------------------
  # Optimizer Service - Java
  # ---------------------------------------------------------------------------
  optimizer:
    build:
      context: ./services/optimizer
      dockerfile: Dockerfile
    container_name: indigoglass-optimizer
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Xmx1g -Xms512m
      - SERVER_PORT=8080
    networks:
      - indigoglass-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # MySQL - Curated Data Warehouse
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: indigoglass-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=indigoglass
      - MYSQL_USER=indigoglass
      - MYSQL_PASSWORD=indigoglass_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./infra/docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - indigoglass-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # MongoDB - Raw Events Store
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0
    container_name: indigoglass-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=indigoglass
      - MONGO_INITDB_ROOT_PASSWORD=indigoglass_mongo_password
      - MONGO_INITDB_DATABASE=indigoglass_raw
    volumes:
      - mongodb_data:/data/db
      - ./infra/docker/mongodb/init:/docker-entrypoint-initdb.d:ro
    networks:
      - indigoglass-net

  # ---------------------------------------------------------------------------
  # Neo4j - Supply Network Graph
  # ---------------------------------------------------------------------------
  neo4j:
    image: neo4j:5.15.0
    container_name: indigoglass-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/neo4j_password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - indigoglass-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redis - Cache & Celery Broker
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.2-alpine
    container_name: indigoglass-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - indigoglass-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------------------
  # MinIO - S3-Compatible Storage (Dev)
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: indigoglass-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - indigoglass-net

  # ---------------------------------------------------------------------------
  # MinIO Setup - Create Buckets
  # ---------------------------------------------------------------------------
  minio-setup:
    image: minio/mc:latest
    container_name: indigoglass-minio-setup
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set minio http://minio:9000 minioadmin minioadmin;
      mc mb minio/models --ignore-existing;
      mc mb minio/exports --ignore-existing;
      mc mb minio/raw-files --ignore-existing;
      exit 0;
      "
    networks:
      - indigoglass-net

# =============================================================================
# Networks
# =============================================================================
networks:
  indigoglass-net:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql_data:
  mongodb_data:
  neo4j_data:
  neo4j_logs:
  redis_data:
  minio_data:
